trigger:
  branches:
    include:
    - '*'
  tags:
    include:
    - '*'

jobs:
  - job: Linux
    displayName: Build & Test Linux
    pool: 
      vmImage: 'ubuntu-latest'
    variables:
      buildConfiguration: 'Release'
      artifactsFolder: '$(Build.SourcesDirectory)/artifacts/'

    steps:
    - script: sudo apt-get install clang zlib1g-dev libkrb5-dev libtinfo5 -y
      displayName: Install requirements
      
    - task: UseDotNet@2
      displayName: "Use .NET 3.x"
      inputs:
        version: '3.x'
        packageType: sdk
    
    - powershell: dotnet publish ./src/TRH/TRH.csproj -c $(buildConfiguration) -r linux-x64 -o $(artifactsFolder)
      displayName: 'Build'

    - powershell: mv TRH trh
      displayName: Rename artifact
      workingDirectory: '$(artifactsFolder)'

    - powershell: strip trh
      displayName: Strip artifact
      workingDirectory: '$(artifactsFolder)'

    - powershell: dotnet test
      displayName: Test

    - task: PublishBuildArtifacts@1
      displayName: Publish
      inputs:
        pathtoPublish: '$(artifactsFolder)'
        artifactName: trh